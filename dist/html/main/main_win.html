<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <meta name=format-detection content="telephone=no,email=no,date=no,aItemress=no"> <title></title> <link rel=stylesheet type=text/css href=../../css/api.css /> <link rel=stylesheet type=text/css href=../../css/aui.css /> <link rel=stylesheet type=text/css href=../../css/aui-skin.css /> <link rel=stylesheet type=text/css href=../../css/tea.css /> <style type=text/css>header{overflow:hidden}footer{border-top:1px solid #ededed}.hidden.aui-hide{visibility:hidden;display:block!important}.aui-bar-tab{color:#999}.aui-bar-tab .aui-active{color:#09f}</style> </head> <body> <div id=app> <header :class="{'aui-hide' : navIndex != 0}"></header> <header class="aui-bar aui-bar-light aui-bar-nav" :class="[{'hidden': hidden}, {'aui-hide': navIndex != 1}]"> <div class="aui-title tea-text-title">新鲜事</div> <a class="aui-btn aui-pull-right" tapmode @click=openWinNews()> <span class="aui-iconfont tea-icon-camera tea-text-title tea-text-blue"></span> </a> </header> <header class="aui-bar aui-bar-light aui-bar-nav" :class="[{'hidden': hidden}, {'aui-hide': navIndex != 2}]"> <div class="aui-title tea-text-title">车友</div> <span class="aui-btn aui-pull-right" tapmode @click=openWinContacts()> <span class="aui-iconfont tea-icon-contacts tea-text-title tea-text-blue"></span> </span> </header> <header :class="[{'hidden': hidden}, {'aui-hide': navIndex != 4}]"></header> <footer class="aui-bar aui-bar-tab" id=footer> <div v-for="(item, index) in list" class=aui-bar-tab-item :class="{'aui-active' : index == navIndex}" tapmode @click=setNavMenuIndex(index);> <div class=aui-badge v-if="item.text == '车友' && unread.total">{{unread.total >= 9 ? '9+' : unread.total }}</div> <i class=aui-iconfont :class=item.icon></i> <div class=aui-bar-tab-label>{{item.text}}</div> </div> </footer> </div> </body> <script src=../../script/api.js></script> <script src=../../script/aui-toast.js></script> <script src=../../script/conn.js></script> <script src=../../script/vue.min.js></script> <script src=../../script/ajpush.js></script> <script src=../../script/tea.js></script> <script type=text/template id=template></script> <script>function init(){dom={},initHeader(),openFrames(),initModule(),initEventListener()}function initModule(){api.require("bMap").getLocation({accuracy:"100m",autoStop:!0,filter:1},function(e,a){if(e.status)return vm.location.longitude=e.lon,vm.location.latitude=e.lat,$api.getStorage("token")&&upLocal(),!0})}function initEventListener(){api.addEventListener({name:"keyback"},function(e,a){if("video"==keybackType)return api.closeFrame({name:"video_frm"}),api.setFrameAttr({name:"video_con_frm",hidden:!0}),api.hideProgress(),void(keybackType="");api.closeWidget({retData:{name:"closeWidget"},animation:{type:"flip",subType:"from_bottom",duration:500}})}),api.addEventListener({name:"messageUnread"},function(e,a){"contacts"==e.value.type&&(vm.unread.contacts=Number(e.value.num)),"friend"==e.value.type&&(vm.unread.friend=Number(e.value.num)),"chat"==e.value.type&&(vm.unread.chat=Number(e.value.num)),vm.unread.total=vm.unread.contacts+vm.unread.friend+vm.unread.chat,void 0===$api.getStorage("token")&&(vm.unread.total=0),setAppIconBadge()}),api.addEventListener({name:"rereportcount"},function(e,a){getnoread()}),api.addEventListener({name:"rehb"},function(e,a){getnoread()}),api.addEventListener({name:"retxl"},function(e,a){getnoread()}),api.addEventListener({name:"getunread"},function(e,a){getnoread()}),api.addEventListener({name:"loginSuccess"},function(e,a){upLocal()})}function closeWin(){api.closeWin()}function openFrames(){vm.list;vm.list.forEach(function(e,a){var t=a===vm.navIndex?e.headerH:vm.winH,n=vm.winH-vm.footerH-e.headerH,i=e.url+e.frameName+".html";api.openFrame({name:e.frameName,url:i,rect:{x:0,y:t,w:"auto",h:n},pageParam:{headerH:e.headerH},bounces:!1})},this)}function initHeader(){for(var e=$api.domAll("header"),a=0,t=e.length;a<t;a++){var n=e[a];$api.fixStatusBar(n),vm.list[a].headerH=$api.offset(n).h,vm.hidden=!1}}function getnoread(){var e=$api.getStorage("ID");api.showProgress({style:"default",animationType:"fade",title:"努力加载中...",text:"请稍候...",modal:!1}),api.ajax({url:website+"index.php?action=getnoread",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:e}}},function(e,a){e&&(vm.unread.system=parseInt(e.noread),gettxlnoread())})}function gettxlnoread(){var e=$api.getStorage("ID");api.ajax({url:website+"index.php?action=gettxlnoread",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:e}}},function(e,a){api.hideProgress(),e&&(vm.unread.contact=parseInt(e.txlnoread),setAppIconBadge())})}function setAppIconBadge(){vm.unread.badge=vm.unread.total+vm.unread.system,ajpush.setBadge({badge:vm.unread.badge}),api.setAppIconBadge({badge:vm.unread.badge}),api.sendEvent({name:"noticeUnread",extra:{unread:vm.unread.system+vm.unread.contact}})}function upLocal(){api.ajax({url:website+"nearby.php?action=position",method:"post",data:{values:{ID:$api.getStorage("ID"),longitude:vm.location.longitude,latitude:vm.location.latitude}}},function(e,a){"1"==e.succ&&console.log("上传成功")})}var header,footer,dom={},vm=null,ajpush=null,keybackType="",headerH,footerH;apiready=function(){var e=api.systemType;ajpush=api.require("ajpush"),"android"==e&&ajpush.init(function(e){e&&e.status});var a={alias:$api.getStorage("ID"),tags:[$api.getStorage("nickname"),$api.getStorage("telphone")]};ajpush.bindAliasAndTags(a,function(e){e.statusCode}),eventListener[e](),vm=new Vue({el:"#app",data:{unread:{total:0,contacts:0,friend:0,chat:0,badge:0,system:0,contact:0},hidden:!0,navIndex:0,winH:api.winHeight,footerH:$api.offset($api.byId("footer")).h,location:{},list:[{text:"首页",icon:"tea-icon-home",headerH:"",frameName:"home_frm",frameGroupName:"",url:"../home/"},{text:"新鲜事",icon:"tea-icon-news",headerH:"",frameName:"news_frm",frameGroupName:"",url:"../new/"},{text:"车友",icon:"tea-icon-friends",headerH:"",frameName:"chat_list_frm",frameGroupName:"",url:"../friends/"},{text:"我的",icon:"tea-icon-me",headerH:"",frameName:"me_frm",frameGroupName:"",url:"../me/"}]},methods:{setNavMenuIndex:function(e){(0==e||tea.token())&&(vm.navIndex=e)},openWinContacts:function(){tea.openWin({name:"contacts_win.html",url:"../friends/contacts_win.html",pageParam:{name:"test"}})},openWinNews:function(){api.execScript({frameName:"news_frm",script:"opennews();"})}},watch:{navIndex:{handler:function(e,a){api.setFrameGroupAttr({name:vm.list[e].frameGroupName,hidden:!1}),api.setFrameGroupAttr({name:vm.list[a].frameGroupName,hidden:!0}),api.setFrameAttr({name:vm.list[e].frameName,rect:{y:vm.list[e].headerH}}),api.setFrameAttr({name:vm.list[a].frameName,rect:{y:vm.winH}})},deep:!0}}}),init()}</script> </html>