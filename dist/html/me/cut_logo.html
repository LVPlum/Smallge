<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <title>user</title> <link rel=stylesheet type=text/css href=../../css/api.css /> <style type=text/css>*{margin:0;padding:0;border-width:0}body{text-align:center;background-color:#000}canvas{background-color:#000;position:absolute}.contain{margin:0 auto;width:auto;height:auto;position:absolute;background-color:#000}.scaleSlider{position:absolute;transform:rotate(-90deg);bottom:20px;left:50%;z-index:99999}.range{z-index:99998;border:2px solid #fff;background:RGBA(0,0,0,0);width:160px;height:160px;padding:0;left:50%;top:50%;margin-top:-80px;margin-left:-80px;position:absolute;display:none}.cut{z-index:99999;width:160px;height:160px;padding:0;left:0;top:0;position:absolute}.homeFooter{position:fixed;bottom:0;height:45px;width:100%;box-sizing:border-box;display:block;background-color:#fff}.homeFooter>nav,.homeFooter>nav>ul{height:100%}.homeFooter>nav>ul{-webkit-box-orient:horizontal;padding:5px;border-top:1px solid #ddd;white-space:nowrap;text-align:center;list-style-type:none}.homeFooter>nav>ul>li{display:block;float:left;width:32%;padding:2px}.homeFooter>nav>ul>li>span:active{color:rgba(0,135,233,1);height:30px;line-height:30px;font-size:1em;font-weight:600}.homeFooter>nav>ul>li>span{color:rgba(99,194,233,1);height:30px;line-height:30px;font-size:1em;font-weight:600}.homeFooter>nav>ul>li>h2{font-size:1em;font-weight:600;color:rgba(99,194,233,1)}</style> </head> <body id=wrap> <div class=contain id=contain> <canvas id=canvas width=480 height=640></canvas> </div> <footer class=homeFooter> <nav> <ul> <li id=activeId tapmode="" onclick=api.closeWin()> <span class="am-icon-sm6 am-icon-back">返回</span> </li> <li tapmode onclick=cut()> <span class="am-icon-sm6 am-icon-cut">裁剪</span> </li> <li tapmode="" onclick=openPicture(0)> <span class="am-icon-sm6 am-icon-picture-o">图库</span> </li> </ul> </nav> </footer> <div id=range class=range></div> </body> <script src=../../script/api.js></script> <script src=../../script/cut/touch.js></script> <script src=../../script/cut/picture.js></script> <script>function openPicture(e){var a=SourceType[e];api.getPicture({sourceType:a,encodingType:"jpg",mediaValue:"pic",destinationType:"url",allowEdit:!0,quality:50,saveToPhotoAlbum:!1},function(e,a){e&&(document.getElementById("range").style.display="block",canvas.width=api.winWidth,canvas.height=api.winHeight,image.src=e.data,image.onload=function(){imageUtil.drawScaleImageInCenter(context,image),scale=canvas.width/image.width,$api.setStorage("bimg",e.data)})})}function cut(){var e=$api.offset($api.dom(".range")),a=parseInt(e.w),t=parseInt(e.h),n=parseInt(api.winWidth),o=parseInt(api.winHeight),c=n/2+(dx=dx||0)-a/2,i=o/2+(dy=dy||0)-t/2;if(console.log("屏幕:"+n+","+o),console.log("对象:"+a+","+t),console.log("dx:"+dx+","+dy),console.log("位置坐标:"+c+","+i),c<0||i<0)api.toast({msg:"圈圈不能跑到图片外"});else{var l=document.createElement("canvas");l.width=a,l.height=t,l.getContext("2d").drawImage(canvas,c,i,a,t,0,0,a,t);var r=l.toDataURL("image/png");console.log(r),$api.setStorage("mylogo",r),api.sendEvent({name:"photo"}),api.closeWin()}}var contain=document.getElementById("contain");contain.style.webkitTransition="all ease 0.05s",touch.on("#contain","touchstart",function(e){e.preventDefault()});var initialScale=.8,currentScale;touch.on("#contain","pinchend",function(e){currentScale=e.scale-1,currentScale=(currentScale=(currentScale=initialScale+currentScale)>4?4:currentScale)<.8?.8:currentScale,context.clearRect(0,0,canvas.width,canvas.height),imageUtil.scaleImgInCenter(context,image,currentScale,!1),console.log("当前缩放比例为:"+currentScale+".")}),touch.on("#contain","pinchend",function(e){initialScale=currentScale,console.log("缩放比例为:"+currentScale+".")}),touch.on("#range","touchstart",function(e){e.preventDefault()});var range=document.getElementById("range"),dx,dy,offx,offy;touch.on("#range","drag",function(e){dx=dx||0,dy=dy||0,console.log("当前x值为:"+dx+", 当前y值为:"+dy+"."),offx=dx+e.x+"px",offy=dy+e.y+"px",console.log("当前offx值为:"+offx+", 当前offy值为:"+offy+"."),this.style.webkitTransform="translate3d("+offx+","+offy+",0)"}),touch.on("#range","dragend",function(e){dx+=e.x,dy+=e.y});var image=new Image,canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),scaleSlider=document.getElementById("scaleSlider"),imageUtil=new MikuCanvasImageUtil,SourceType=["library","camera","album"],scale=1,footHeight=45;apiready=function(){var e=$api.offset($api.dom(".homeFooter"));footHeight=parseInt(e.h),range.style.display="block",openPicture(1)}</script> </html>