<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <meta name=format-detection content="telephone=no,email=no,date=no,aItemress=no"> <title>修改个人资料</title> <link rel=stylesheet type=text/css href=../../css/api.css /> <link rel=stylesheet type=text/css href=../../css/aui.css /> <link rel=stylesheet type=text/css href=../../css/aui-skin.css /> <link rel=stylesheet type=text/css href=../../css/tea.css /> <style type=text/css>body,html{background-color:#f2f5f8;overflow-x:hidden}.head-img{height:0;padding-bottom:100%;background:no-repeat 50%;background-size:cover}.get-img-btn>p{width:12.5rem;height:2.3rem;margin:.75rem auto;font-size:.8rem;line-height:2.3rem;text-align:center;background-color:#fff;color:#333;border-radius:99px;border:1px solid #ccc}.aui-card-list-content-padded{width:14rem;height:14rem;margin:0 auto}.aui-card-list-content-padded>img{width:100%;height:100%;object-fit:cover}.aui-list-item-input{width:100%;height:7.5rem;position:relative;margin:0 auto;color:#333;background-color:#fff;border-radius:4px}.aui-list-item-input>textarea{width:100%;height:100%}#textarea-index{position:absolute;right:0;bottom:0;margin:0 .5rem;color:#999}#er-wei-ma,#header-img,#nickname-content,#textarea-content{display:none}.icon-close{width:1rem;height:1rem;line-height:1rem;margin:-.5rem .75rem;text-align:center;position:absolute;top:50%;right:0;color:#fff;background-color:#ddd;border-radius:999px;display:none}</style> </head> <body> <header id=header-img> <div class=aui-card-list> <div class=aui-card-list-content> <div id=head-img class=head-img style=background-image:url(../../image/3.jpg)></div> </div> </div> <div class=get-img-btn style=margin-top:1.5rem> <p id=photograph-btn tapmode onclick=openCamera()>拍照</p> </div> <div class=get-img-btn> <p id=get-photo-btn tapmode onclick=getPhoto_img()>从手机相册选择</p> </div> </header> <section> <div id=er-wei-ma> <div class=aui-card-list> <ul class="aui-list aui-media-list"> <li class="aui-list-item aui-list-item-middle"> <div class=aui-media-list-item-inner> <div class=aui-list-item-media style=width:3.25rem;height:3.5rem> <img id=er-wei-ma-userHead-img src=../../image/3.jpg class=aui-img-round style=height:100%;width:100%> </div> <div class=aui-list-item-inner> <div class=aui-list-item-text> <div id=er-wei-ma-user-name class="aui-list-item-title aui-font-size-16"></div> </div> </div> </div> </li> </ul> <div class=aui-card-list-content-padded style=padding-bottom:2rem> <img id=er-wei-ma-img src=""> </div> </div> <div class=get-img-btn> <p id=save-photo-btn tapmode onclick=savalbum()>保存到相册</p> </div> </div> <div id=textarea-content class=aui-content-padded> <div class="aui-list-item-input aui-margin-b-15"> <textarea id=textarea-val class=aui-padded-15 placeholder=个人简介 maxlength=30 tapmode oninput=isLength(this)></textarea> <span id=textarea-index>30</span> </div> </div> <div id=nickname-content class=aui-content-padded> <div class="aui-list-item-input aui-margin-b-15" style=height:2.3rem;position:relative> <input id=set-nickname class=aui-padded-15 type=text maxlength=35 placeholder=设置昵称 tapmode oninput=isShow_colse_icon(this)> <span id=icon-close class="icon-close aui-font-size-20" tapmode onclick=colseIput(this)>&times;</span> </div> </div> </section> </body> <script src=../../script/api.js></script> <script src=../../script/tea.js></script> <script src=../../script/conn.js></script> <script src=../../script/doT.min.js></script> <script src=../../script/zepto.min.js></script> <script type=text/template id=template></script> <script>function closeWin(){api.closeWin()}function isLength(e){document.getElementById("textarea-index").innerHTML=30-e.value.length}function isShow_colse_icon(e){0!==e.value.length?document.getElementById("icon-close").style.display="block":document.getElementById("icon-close").style.display="none"}function colseIput(e){$api.val($api.byId("set-nickname"),""),e.style.display="none"}function savalbum(){api.require("FNScanner").encodeImg({content:"adf:"+telphone,saveToAlbum:!0,saveImg:{w:400,h:400}},function(e,a){e.status?api.toast({msg:"保存成功"}):alert(JSON.stringify(a))})}function openCamera(){api.getPicture({sourceType:"camera",destinationType:"url",mediaValue:"pic",quality:50,saveToPhotoAlbum:!0},function(e,a){if(e&&e.data){var t=e.data;showp("图片处理中","请稍候..."),imgCompress(t,.5,.5,getExt(t),function(e){uplogo(e,e,api.pageParam.id,api.pageParam.nickname),api.hideProgress()})}else api.toast({msg:"没有选择，或者选择出错"})})}function getPhoto_img(){uiMediaScanner.open({type:"picture",column:4,classify:!0,max:1,sort:{key:"time",order:"desc"},texts:{stateText:"已选*项",cancelText:"取消",finishText:"完成"},styles:{bg:"#fff",mark:{icon:"",position:"bottom_left",size:20},nav:{bg:"#b23e4b",stateColor:"#fff",stateSize:18,cancelBg:"rgba(0,0,0,0)",cancelColor:"#fff",cancelSize:18,finishBg:"rgba(0,0,0,0)",finishColor:"#fff",finishSize:18}}},function(e){if(e)for(var a=e.list.length,t=0;t<a;t++)!function(a){var t=e.list[a],i=t.path;t.thumbPath;isIOS?uiMediaScanner.transPath({path:i},function(e){showp("图片处理中","请稍候..."),imgCompress(e.path,.5,.5,t.suffix,function(e){uplogo(e,e,api.pageParam.id,api.pageParam.nickname),api.parseTapmode(),api.hideProgress()})}):(showp("图片处理中","请稍候..."),imgCompress(i,.5,.5,t.suffix,function(e){uplogo(e,e,api.pageParam.id,api.pageParam.nickname),api.parseTapmode(),api.hideProgress()}))}(t)})}function NewGuid(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function getNowFormatDate(){var e=new Date,a=e.getFullYear(),t=e.getMonth()+1,i=e.getDate();return t>=1&&t<=9&&(t="0"+t),i>=0&&i<=9&&(i="0"+i),a+"-"+t+"-"+i}function getExt(e){return e.substring(e.lastIndexOf(".")+1)}function imgCompress(e,a,t,i,n){var o=api.cacheDir+"/"+getNowFormatDate()+"/",r=NewGuid()+"."+i;imageFilter.compress({img:e,quality:a,scale:a,save:{album:!1,imgPath:o,imgName:r}},function(e,a){e?n(o+r):alert(JSON.stringify(a))})}function uploadFile(e,a,t){api.ajax({url:e,method:"post",timeout:30,dataType:"json",returnAll:!1,data:{files:{upfile:a},values:{ID:id}}},function(e,a){e?1==e.statu?t(e.path):0==e.statu&&alert("上传失败"):api.alert({msg:"错误码："+a.code+"；错误信息："+a.msg+"；网络状态码："+a.statusCode})})}function uplogo(e,a,t,i){showp("图像处理中...","请稍候..."),api.ajax({url:website+"index.php?action=chlogo",method:"post",timeout:100,dataType:"json",returnAll:!1,data:{values:{img:e,ID:t},files:{upfile:a}}},function(e,a){if(e){if(!e.errmsg){var n=e.imgurl;api.ajax({url:website+"rong/index2.php?action=getrongtoken",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:t,nickname:i,img:e.imgurl}}},function(e,a){e?200==e.code&&(api.toast({msg:"头像更改成功"}),$api.setStorage("rongtoken",e.token),$api.setStorage("img",n),$api.rmStorage("bimg"),$api.rmStorage("mylogo"),api.sendEvent({name:"save_personal_data",extra:{img:n}}),$("#head-img").css("background-image","url("+n+")"),api.hideProgress()):(api.hideProgress(),api.alert({msg:"错误码："+a.code+"；错误信息："+a.msg+"网络状态码："+a.statusCode}))})}}else api.alert({msg:"错误码："+a.code+"；错误信息："+a.msg+"网络状态码："+a.statusCode})})}function postdate_newname(){var e=$api.val($api.byId("set-nickname")),a=api.pageParam.id,t=api.pageParam.token,i=api.pageParam.img;return""==e?(api.toast({msg:"昵称不能为空"}),!1):e.length<2?(api.toast({msg:"昵称必需在两个字以上"}),!1):void api.ajax({url:website+"chsysset.php?action=chnickname",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:a,token:t,newname:e}}},function(t,n){t&&("ok"==t.succ?($api.setStorage("nickname",e),api.sendEvent({name:"save_personal_data",extra:{nickname:e}}),getrongtoken(a,e,i),api.closeWin()):api.toast({msg:t.msg}))})}function getrongtoken(e,a,t){api.ajax({url:website+"rong/index2.php?action=getrongtoken",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:e,nickname:a,img:t}}},function(e,a){e&&(e.errmsg||$api.setStorage("rongtoken",e.token))})}function postdate_profile(){var e=$api.val($api.byId("textarea-val")),a=api.pageParam.id,t=api.pageParam.token;api.ajax({url:website+"chsysset.php?action=chinfo",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:a,token:t,profile:e}}},function(a,t){a?a.errmsg||("ok"==a.succ?(api.sendEvent({name:"save_personal_data",extra:{profile:e}}),api.closeWin()):api.toast({msg:a.msg})):api.alert({msg:"错误码："+t.code+"；错误信息："+t.msg+"网络状态码："+t.statusCode})})}var uiMediaScanner=null,imageFilter=null,imageBrowser=null,isIOS=!1,id=null;apiready=function(){uiMediaScanner=api.require("UIMediaScanner"),imageFilter=api.require("imageFilter"),imageBrowser=api.require("imageBrowser"),isIOS="ios"==api.systemType,api.parseTapmode();var e=api.pageParam.type,a=api.pageParam,t=a.nickname,i=a.telphone;a.token;id=a.id;var n=a.img,o=a.profile||"";1===e?($("#header-img").show(),$("#er-wei-ma").hide(),$("#textarea-content").hide(),$("#nickname-content").hide(),$("#head-img").css("background-image","url("+n+")")):2===e?($("#header-img").hide(),$("#er-wei-ma").hide(),$("#textarea-content").hide(),$("#nickname-content").show(),$("#set-nickname").val(t),$("#set-nickname").val()&&$("#icon-close").show()):3===e?($("#header-img").hide(),$("#er-wei-ma").show(),$("#textarea-content").hide(),$("#nickname-content").hide(),$("#er-wei-ma-userHead-img").attr("src",n),$("#er-wei-ma-user-name").html(t)):4===e&&($("#header-img").hide(),$("#er-wei-ma").hide(),$("#textarea-content").show(),$("#nickname-content").hide(),$("#textarea-val").val(o)),$("#textarea-index").html(30-$("#textarea-val").val().length),api.parseTapmode(),api.require("FNScanner").encodeImg({content:"adf:"+i,saveImg:{path:"fs://myqrcode.png",w:300,h:300}},function(e,a){e.status?$api.attr($api.byId("er-wei-ma-img"),"src",e.imgPath):alert(JSON.stringify(a))}),api.addEventListener({name:"_personal_data"},function(a,t){a&&(2===e?postdate_newname():4===e&&postdate_profile())})};var dom={},telphone=$api.getStorage("telphone"),data={},values={}</script> </html>