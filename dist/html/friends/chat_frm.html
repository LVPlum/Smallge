<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <meta name=format-detection content="telephone=no,email=no,date=no,aItemress=no"> <title></title> <link rel=stylesheet type=text/css href=../../css/api.css /> <link rel=stylesheet type=text/css href=../../css/aui.css /> <link rel=stylesheet type=text/css href=../../css/aui-skin.css /> <link rel=stylesheet type=text/css href=../../css/tea.css /> <style type=text/css>.aui-chat-media img{border-radius:4px!important}.duration{font-size:.7rem}.voice{height:.95rem;margin-bottom:-.2rem;width:.75rem;background-image:-webkit-linear-gradient(right,#999,#999 50%,transparent 50%),-webkit-linear-gradient(right,#999,#999 50%,transparent 50%),-webkit-linear-gradient(right,#999,#999 50%,transparent 50%);background-image:-o-linear-gradient(right,#999,#999 50%,transparent 50%),-o-linear-gradient(right,#999,#999 50%,transparent 50%),-o-linear-gradient(right,#999,#999 50%,transparent 50%);background-image:linear-gradient(to left,#999,#999 50%,transparent 50%),linear-gradient(to left,#999,#999 50%,transparent 50%),linear-gradient(to left,#999,#999 50%,transparent 50%);background-size:.3rem 40%,.3rem 100%,.3rem 80%;background-repeat:no-repeat;background-position:-.15rem bottom,.15rem bottom,100% bottom}.voice-play{animation:voice .8s linear 0s infinite alternate;-moz-animation:voice .8s linear 0s infinite alternate;-webkit-animation:voice .8s linear 0s infinite alternate;-o-animation:voice .8s linear 0s infinite alternate}@keyframes voice{0%{background-size:.3rem 40%,.3rem 100%,.3rem 80%}25%{background-size:.3rem 80%,.3rem 80%,.3rem 100%}50%{background-size:.3rem 100%,.3rem 40%,.3rem 80%}75%{background-size:.3rem 80%,.3rem 80%,.3rem 40%}100%{background-size:.3rem 40%,.3rem 100%,.3rem 80%}}.aui-chat .aui-chat-left .aui-chat-content{clear:both;background-color:#fff;border-radius:0 .3rem .3rem .3rem;color:#333}.aui-chat .aui-chat-right .aui-chat-content{background-color:#4091ed;border-radius:.35rem 0 .35rem .35rem;color:#fff}.aui-chat-right .voice{opacity:.4;background-image:-webkit-linear-gradient(right,#fff,#fff 50%,transparent 50%),-webkit-linear-gradient(right,#fff,#fff 50%,transparent 50%),-webkit-linear-gradient(right,#fff,#fff 50%,transparent 50%);background-image:-o-linear-gradient(right,#fff,#fff 50%,transparent 50%),-o-linear-gradient(right,#fff,#fff 50%,transparent 50%),-o-linear-gradient(right,#fff,#fff 50%,transparent 50%);background-image:linear-gradient(to left,#fff,#fff 50%,transparent 50%),linear-gradient(to left,#fff,#fff 50%,transparent 50%),linear-gradient(to left,#fff,#fff 50%,transparent 50%)}.aui-chat-media.tea img{border-radius:4px}.aui-chat-inner{max-width:85%!important}.aui-list-item-media{padding:.75rem .5rem .75rem 0!important;width:5.25rem!important}.aui-list-item-media img{width:4.75rem;height:3.25rem}</style> </head> <body> <div id=app class=aui-chat> <template v-for="(item, index) in msgList"> <div v-if="item.msgContentType != 'RC:ImgTextMsg'" class=aui-chat-item :class="[item.msgDirection == 'SEND'? 'aui-chat-right' : 'aui-chat-left']"> <div class=aui-chat-media @click=openWinInfo(item.senderId) tapmode> <img :src=item.msgAvatar /> </div> <div class=aui-chat-inner :data-index=index> <div class=aui-chat-content> <div v-if="item.msgContentType == 'RC:TxtMsg'" v-html=_transEmo(item.msgContent.text)> </div> <div v-if="item.msgContentType == 'RC:VcMsg'" @click="playVoice(index, item.msgContent.voicePath)" tapmode> <template v-if="item.msgDirection == 'SEND'"> <span>{{item.msgContent.duration + '″'}}</span> <span class=duration v-html=setVoiceLength(item.msgContent.duration)></span> <span class=voice :class="{'voice-play' : index == voiceIndex}"></span> </template> <template v-if="item.msgDirection == 'RECEIVE'"> <span class=voice :class="{'voice-play' : index == voiceIndex}"></span> <span class=duration v-html=setVoiceLength(item.msgContent.duration)></span> <span>{{item.msgContent.duration + '″'}}</span> </template> </div> <img v-if="item.msgContentType == 'RC:ImgMsg'" :src=item.msgContent.thumbPath style=width:100% tapmode @click=openBigImg(item.msgContent.imageUrl)> </div> <div class=aui-chat-status> <i class=aui-iconfont :class="[{'aui-icon-info' : item.msgStatus}, {'tea-text-red' : item.msgStatus == 'error'}]"></i> </div> </div> </div> <ul v-else class="aui-list aui-media-list aui-margin-b-10 aui-chat-item"> <li class=aui-list-item tapmode @click="openWinWare(item.msgContent.description, item.msgContent.title)"> <div class=aui-media-list-item-inner> <div class=aui-list-item-media> <img :src=item.msgContent.imageUrl /> </div> <div class="aui-list-item-inner aui-padded-r-0"> <div class=aui-list-item-text> <div class="aui-list-item-title aui-font-size-14">{{item.msgContent.title}}</div> </div> </div> </div> </li> <li class=aui-list-item style=min-height:1.85rem> <div class="aui-list-item-inner aui-text-center tea-text-red" style=min-height:1.85rem tapmode @click="sendWareAgain(item.msgContent.description, item.msgContent.title, item.msgContent.imageUrl)">发送商品信息</div> </li> </ul> </template> </div> </body> <script src=../../script/api.js></script> <script src=../../script/aui-toast.js></script> <script src=../../script/conn.js></script> <script src=../../script/emo.js></script> <script src=../../script/hammer.min.js></script> <script src=../../script/vue.min.js></script> <script src=../../script/tea.js></script> <script>function init(){dom={},(vm=new Vue({el:"#app",data:{msgList:[],userId:$api.getStorage("ID"),voiceIndex:null},methods:{init:function(){api.showProgress({modal:!1}),api.sendEvent({name:"getLastMsgStart",extra:{chatType:api.pageParam.chatType,chatId:api.pageParam.chatId}})},openWinInfo:function(e){e=void 0===e?vm.userId:e,api.openWin({name:"user_info_win",url:"../location/user_info_win.html",bounces:!1,pageParam:{friendID:e,pageType:"chat"}})},openBigImg:function(e){var t=[];vm.msgList.forEach(function(e){void 0!==e.msgContent.imageUrl&&t.push(e.msgContent.imageUrl)});var a=t.indexOf(e);photoBrowser.open({images:t,placeholderImg:"widget://image/holder.png",activeIndex:a,bgColor:"#000"},function(e,t){e&&"click"===e.eventType&&photoBrowser.close()})},playVoice:function(e,t){vm.voiceIndex=e,api.stopPlay(),api.startPlay({path:t},function(){vm.voiceIndex=null})},openWinWare:function(e,t){tea.openWin({name:"ware_win",url:"../ware/ware_win.html",pageParam:{wareId:e,wareTitle:t}})},sendWareAgain:function(e,t,a){var n={username:$api.getStorage("nickname"),userphoto:$api.getStorage("avatar"),wareId:e,wareTitle:t};api.sendEvent({name:"sendMsgStart",extra:{msgType:"richmsg",chatType:"PRIVATE",chatId:api.pageParam.chatId,content:a,extra:JSON.stringify(n)}})}},watch:{msgList:{handler:function(){vm.$nextTick(function(){for(var e=$api.domAll(".aui-chat-right .aui-chat-inner"),t={},a=0;a<e.length;a++)!function(a){var n=e[a];t[a]=new Hammer(n),t[a].on("press",function(t){var n=$api.attr(e[a],"data-index");alert(vm.msgList[n].msgId),api.confirm({title:"",msg:"确定撤回这条消息吗？",buttons:["确定","取消"]},function(e,t){1==e.buttonIndex&&(api.alert({msg:"点击了确定"}),api.sendEvent({name:"delMsg",extra:{msgId:vm.msgList[n].msgId}}),api.sendEvent({name:"sendMsgStart",extra:{msgType:"text",chatType:"PRIVATE",chatId:api.pageParam.chatId,content:e.msg,extra:JSON.stringify(userJson)}}))})})}(a)})},deep:!0}}})).init(),initModule(),initEventListener()}function initModule(){photoBrowser=api.require("photoBrowser")}function initEventListener(){api.setRefreshHeaderInfo({visible:!0,loadingImg:"widget://image/refresh.png",bgColor:"#f4f4f4",textColor:"#fff",textDown:"下拉刷新...",textUp:"松开刷新...",showTime:!0},function(e,t){if(vm.msgList.length<1)api.refreshHeaderLoadDone();else{var a=vm.msgList[0].msgId;api.sendEvent({name:"getHistoryMessages",extra:{chatType:api.pageParam.chatType,chatId:api.pageParam.chatId,lastMsgId:a}})}}),api.addEventListener({name:"getHistoryMessagesDone"},function(e,t){e.value.result.length<1?api.refreshHeaderLoadDone():getChatData(e.value.result,function(e){vm.msgList=e.concat(vm.msgList),api.refreshHeaderLoadDone()})}),api.addEventListener({name:"tap"},function(){api.sendEvent({name:"closeKeyboard",extra:{key:" value"}})}),api.addEventListener({name:"scrollButton"},function(e,t){setTimeout(function(){tea.scroll("bottom")},30)}),api.addEventListener({name:"sendMsgPrepare"},function(e,t){e&&e.value&&(getChatData(e.value,function(e){e[0].msgStatus="prepare",vm.msgList=vm.msgList.concat(e)}),setTimeout(function(){tea.scroll("bottom")},50))}),api.addEventListener({name:"sendMsgSuccess"},function(e,t){e&&e.value&&vm.msgList.forEach(function(t){t.msgId==e.value.messageId&&(t.msgStatus="")})}),api.addEventListener({name:"sendMsgError"},function(e,t){e&&e.value&&vm.msgList.forEach(function(t){t.msgId==e.value.messageId&&(t.msgStatus="error")})}),api.addEventListener({name:"getLastMsgEnd"},function(e,t){e&&e.value&&(getChatData(e.value,function(e){vm.msgList=vm.msgList.concat(e)}),setTimeout(function(){tea.scroll("bottom"),api.hideProgress()},300),api.sendEvent({name:"clearUnread",extra:{chatType:"PRIVATE",chatId:api.pageParam.chatId}}))}),api.addEventListener({name:"receivedMsg"},function(e,t){e&&e.value&&(getChatData(e.value,function(e){vm.msgList=vm.msgList.concat(e)}),setTimeout(function(){tea.scroll("bottom"),api.hideProgress()},300),api.sendEvent({name:"clearUnread",extra:{chatType:"PRIVATE",chatId:api.pageParam.chatId}}))})}function getChatData(e,t){var a=[],n=[];e="string"==typeof e?JSON.parse(e):e;for(var s=0,i=(e=Array.isArray(e)?e:[e]).length;s<i;s++){var r=e[s];if(r.msg=r.latestMessage?r.latestMessage:r.content,"RC:CmdMsg"!=r.objectName){var o=$api.strToJson(r.msg.extra),m={senderId:r.senderUserId,msgId:r.messageId,msgTime:r.sentTime,msgAvatar:o.userphoto,msgName:o.username,msgContent:r.msg,msgContentType:r.objectName,msgType:r.conversationType,msgDirection:r.messageDirection,msgStatus:""};a.push(m.senderId),n.push(m)}}a.length<1?t(n.reverse()):getUsersInfo(a.toString(),function(e){for(var a=0;a<e.length;a++)for(var s=e[a],i=0;i<n.length;i++){var r=n[i];r.senderId==s.userid&&(r.msgAvatar=website+s.userphoto,r.msgName=s.username)}t(n.reverse())})}function getUsersInfo(e,t){tea.ajax({url:website+"rong/index.php?action=getlastuserlist&ids="+e,method:"get",timeout:30,dataType:"json",returnAll:!1},function(e,a){if(!e)return tea.toast("ajax"),!1;t(e)})}var dom={},vm=null,imageBrowser=null;apiready=function(){init()},Vue.prototype.setVoiceLength=function(e){e>30&&(e=30);for(var t=Math.ceil(parseInt(e)/3),a="",n=0;n<t;n++)a+="&nbsp&nbsp&nbsp";return a}</script> </html>