<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <title>发现</title> <link rel=stylesheet type=text/css href=../../css/aui18/aui.css /> <link rel=stylesheet type=text/css href=../../css/aui18/common.css /> </head> <style type=text/css>.gekai{padding-top:10px}.yb{padding-left:5px}.touxian{color:#ff4242}.upload-img{height:0;padding-bottom:100%;background:no-repeat 50%;background-size:cover}.icon-close{width:1rem;height:1rem;position:absolute;top:4px;right:4px;text-align:center;line-height:1rem;color:#fff;background-color:rgba(255,0,0,.5)}.aui-row{overflow:hidden;margin:0}.aui-row-padded{margin-left:-.125rem;margin-right:-.125rem}.aui-row-padded [class*=aui-col-xs-]{padding:.125rem}.aui-col-xs-4{position:relative;float:left;width:33.33333333%}</style> <body> <div class="aui-content gekai"> <ul class=aui-list-view> <li class="aui-list-view-cell aui-img" id=seelogo></li> <li class=aui-list-view-cell> 个人简介<span class=aui-pull-right id=pinfo></span> </li> </ul> <p class=aui-text-center>个人风采</p> <div class="aui-list-item-inner aui-padded-10" style=background-color:#fff;margin-bottom:2.5rem> <div class="aui-row aui-row-padded" id=imgslist> <div id=add-img-btn class=aui-col-xs-4 tapmode onclick=addImg()> <div class=upload-img style=background-image:url(../../image/xinxian_jia@2x.png)></div> </div> </div> </div> </div> <div class=aui-btn-row id=sendmsg> </div> <div class=aui-content id=seemorebtn> </div> </body> <script src=../../script/api.js></script> <script src=../../script/conn.js></script> <script src=../../script/tea.js></script> <script src=../../script/aui-toast.js></script> <script src=../../script/zepto.min.js></script> <script>function getindexinfo(){var i=api.pageParam.index,e=api.pageParam.key,a=$api.getStorage("telphone"),t=gettoken(a);showp("数据加载中..","请稍候.."),api.ajax({url:website+"friendship.php?action=info",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{index:i,key:e,token:t}}},function(i,e){i?i.errmsg||(msgtoken=i.token,ID=i.ID,nickname=i.nickname,img=i.img,$api.html($api.byId("seelogo"),'<img class="aui-img-object aui-pull-left" src="'+i.img+'" tapmode onclick="openImageBrowser(\''+i.bimg+'\')"><div class="aui-img-body">'+i.nickname+' <span class="touxian"> [头衔:'+i.tx+'] </span><p class="aui-ellipsis-2">'+i.telphone+"</p></div>"),loadprofile(i.profile),showmsgbuttom(),api.hideProgress(ID),seemorebtn(ID)):(api.hideProgress(),api.alert({msg:"错误码："+e.code+"；错误信息："+e.msg+"网络状态码："+e.statusCode}))})}function getidinfo(){var i=api.pageParam.friid;showp("数据加载中..","请稍候.."),api.ajax({url:website+"friendship.php?action=infobyid",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{friid:i}}},function(i,e){if(i){if(!i.errmsg){msgtoken=i.token,ID=i.ID,nickname=i.nickname,img=i.img;var a=$api.byId("seelogo");$api.html(a,'<img class="aui-img-object aui-pull-left" src="'+i.img+'" tapmode onclick="openImageBrowser(\''+i.bimg+'\')"><div class="aui-img-body">'+i.nickname+' <span class="touxian"> [头衔:'+i.tx+'] </span><p class="aui-ellipsis-2">'+i.telphone+"</p></div>"),loadprofile(i.profile),tea.showp("数据加载中..","请稍候..",!0),api.ajax({url:website+"friendship.php?action=checkfriend",method:"post",timeout:30,data:{values:{id:$api.getStorage("ID"),fid:api.pageParam.friid}}},function(i,e){if(api.hideProgress(),!i)return tea.toast("ajax"),!1;1==i.succ&&showmsgbuttom(),0==i.succ&&showAddbuttom()}),api.hideProgress(),seemorebtn(ID)}}else api.hideProgress(),api.alert({msg:"错误码："+e.code+"；错误信息："+e.msg+"网络状态码："+e.statusCode})})}function seemorebtn(i){if(i==$api.getStorage("ID")){e="我";loadfc(i,1)}else{var e="TA";loadfc(i),$api.addCls($api.byId("add-img-btn"),"aui-hide")}$api.html($api.byId("seemorebtn"),'<div class="aui-btn-row"><div class="aui-btn aui-btn-block aui-btn-success" onclick="opentanews('+i+')">查看'+e+"的新鲜事</div></div>")}function openImageBrowser(i){imageBrowser.openImages({imageUrls:[i],showList:!1})}function openImageList(i){var e=$api.attr(i,"data-src"),a=imgs.indexOf(e);-1==a&&(a=0),imageBrowser.openImages({imageUrls:imgs,showList:!1,activeIndex:a})}function showmsgbuttom(){var i=$api.byId("sendmsg");api.pageParam.friid!=$api.getStorage("ID")&&$api.html(i,'<div class="aui-btn aui-btn-block aui-btn-info" onclick="sendmsg();">发送消息</div>')}function showAddbuttom(){var i=$api.byId("sendmsg");api.pageParam.friid!=$api.getStorage("ID")&&$api.html(i,'<div class="aui-btn aui-btn-block aui-btn-info" onclick="addFriend();">添加好友</div>')}function sendmsg(){api.openWin({name:"发送消息",url:"chat_win.html",vScrollBarEnabled:!1,pageParam:{chatId:ID,chatName:nickname,chatAvatar:img,msgtoken:msgtoken,chatType:"PRIVATE"}})}function addFriend(){var i=$api.getStorage("telphone"),e=$api.getStorage("nickname"),a=gettoken(i);api.ajax({url:website+"friendship.php?action=sendfrimsg",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{token:a,fritoken:msgtoken,myname:e}}},function(i,e){i?i.errmsg||("no"==i.succ?api.alert({msg:i.msg}):(api.sendEvent({name:"reloaddate"}),api.sendEvent({name:"updataDot"}),tea.toast("success"),api.closeToWin({name:"main_win",animation:{type:"flip",subType:"from_bottom",duration:500}}))):api.alert({msg:"错误码："+e.code+"；错误信息："+e.msg+"网络状态码："+e.statusCode})})}function loadfc(i,e){var a="";normalW=100,api.ajax({url:website+"chsysset.php?action=loadfc",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:i}}},function(i,t){if(i){for(var s=0,o=i.length;s<o;s++){var n=i[s],r=website+"userfc_img/"+n.pic;imgs.push(r),a+=1==e?'<div class="aui-col-xs-4" ><div  tapmode onclick="openImageList(this)"  data-src="'+r+'" class="upload-img upload-imgs" style="background-image:url('+website+"userfc_img/"+n.pic+')"></div><div  class="icon-close" data-img="'+r+'" data-src="'+n.pic+'" tapmode onclick="closeImg(this);">&times;</div></div>':'<div class="aui-col-xs-4"><div tapmode onclick="openImageList(this)" data-src="'+r+'" class="upload-img upload-imgs" style="background-image:url('+website+"userfc_img/"+n.pic+')"></div></div>'}$api.before($api.byId("add-img-btn"),a),checkadd()}})}function loadprofile(i){$api.html($api.byId("pinfo"),i)}function opentanews(i){api.openWin({name:"tanews_win",url:"../news/tanewslist_win.html",vScrollBarEnabled:!1,pageParam:{ID:i}})}function addImg(){api.actionSheet({title:"选择来源",buttons:["相机拍摄","浏览相册"]},function(i,e){switch(i.buttonIndex){case 1:api.getPicture({sourceType:"camera",destinationType:"url",mediaValue:"pic",quality:50,saveToPhotoAlbum:!0},function(i,e){if(i&&i.data){var a=i.data;showp("图片处理中","请稍候..."),imgCompress(a,.8,.8,getExt(a),function(i){uploadFile(website+"upfc.php",i,function(i){imgs.push(website+"userfc_img/"+i);imgs.indexOf(website+"userfc_img/"+i);var e='<div class="aui-col-xs-4"><div  tapmode onclick="openImageList(this)" data-src="'+website+"userfc_img/"+i+'" class="upload-img upload-imgs" style="background-image:url('+website+"userfc_img/"+i+')"></div><div  class="icon-close" data-img="'+website+"userfc_img/"+i+'" data-src="'+i+'" tapmode onclick="closeImg(this)">&times;</div></div>';$api.before($api.byId("add-img-btn"),e),checkadd(),api.parseTapmode(),api.hideProgress()})})}else api.toast({msg:"没有选择，或者选择出错"})});break;case 2:uiMediaScanner.open({type:"picture",column:4,classify:!0,max:1,sort:{key:"time",order:"desc"},texts:{stateText:"已选*项",cancelText:"取消",finishText:"完成"},styles:{bg:"#fff",mark:{icon:"",position:"bottom_left",size:20},nav:{bg:"#b23e4b",stateColor:"#fff",stateSize:18,cancelBg:"rgba(0,0,0,0)",cancelColor:"#fff",cancelSize:18,finishBg:"rgba(0,0,0,0)",finishColor:"#fff",finishSize:18}}},function(i){if("cancel"==i.eventType&&api.toast({msg:"没有选择，或者选择出错"}),"confirm"==i.eventType)for(var e=i.list.length,a=0;a<e;a++)!function(e){var a=i.list[e],t=a.path;a.thumbPath;isIOS?uiMediaScanner.transPath({path:t},function(i){showp("图片处理中","请稍候..."),imgCompress(i.path,.8,.8,a.suffix,function(i){uploadFile(website+"upfc.php",i,function(i){imgs.push(website+"userfc_img/"+i);imgs.indexOf(website+"userfc_img/"+i);var e='<div class="aui-col-xs-4" ><div  tapmode onclick="openImageList(this)" data-src="'+website+"userfc_img/"+i+'" class="upload-img upload-imgs" style="background-image:url('+website+"userfc_img/"+i+')"></div><div  class="icon-close"  data-img="'+website+"userfc_img/"+i+'" data-src="'+i+'" tapmode onclick="closeImg(this)">&times;</div></div>';$api.before($api.byId("add-img-btn"),e),checkadd(),api.parseTapmode(),api.hideProgress()})})}):(showp("图片处理中","请稍候..."),imgCompress(t,.8,.8,a.suffix,function(i){uploadFile(website+"upfc.php",i,function(i){imgs.push(website+"userfc_img/"+i);imgs.indexOf(website+"userfc_img/"+i);var e='<div class="aui-col-xs-4" ><div  tapmode onclick="openImageList(this)" data-src="'+website+"userfc_img/"+i+'" class="upload-img upload-imgs" style="background-image:url('+website+"userfc_img/"+i+')"></div><div  class="icon-close"  data-img="'+website+"userfc_img/"+i+'" data-src="'+i+'" tapmode onclick="closeImg(this)">&times;</div></div>';$api.before($api.byId("add-img-btn"),e),checkadd(),api.parseTapmode(),api.hideProgress()})}))}(a)})}})}function uploadFile(i,e,a){api.ajax({url:i,method:"post",timeout:30,dataType:"json",returnAll:!1,data:{files:{upfile:e},values:{ID:$api.getStorage("ID")}}},function(i,e){i?1==i.statu?a(i.path):0==i.statu&&alert("上传失败"):api.alert({msg:"错误码："+e.code+"；错误信息："+e.msg+"；网络状态码："+e.statusCode})})}function checkadd(){$(".upload-imgs").length<6?$("#add-img-btn").show():$("#add-img-btn").hide()}function NewGuid(){function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i()}function getNowFormatDate(){var i=new Date,e=i.getFullYear(),a=i.getMonth()+1,t=i.getDate();return a>=1&&a<=9&&(a="0"+a),t>=0&&t<=9&&(t="0"+t),e+"-"+a+"-"+t}function getExt(i){return i.substring(i.lastIndexOf(".")+1)}function imgCompress(i,e,a,t,s){var o=api.cacheDir+"/"+getNowFormatDate()+"/",n=NewGuid()+"."+t;imageFilter.compress({img:i,quality:e,scale:e,save:{album:!1,imgPath:o,imgName:n}},function(i,e){i?s(o+n):alert(JSON.stringify(e))})}function closeImg(i){return api.confirm({title:"温馨提示",msg:"您确定要删除该图片吗？",buttons:["确定","取消"]},function(e,a){1==e.buttonIndex&&api.ajax({url:website+"chsysset.php?action=delfc",method:"post",timeout:30,data:{values:{pic:$(i).attr("data-src")}}},function(e,a){if("ok"==e.succ)return $(i).parent().remove(),api.toast({msg:"删除成功！"}),imgs.remove_arr($(i).attr("data-img")),$api.remove(i),checkadd(),!1})}),!1}var msgtoken,ID,nickname,img,imageBrowser=null,imgs=[];apiready=function(){uiMediaScanner=api.require("UIMediaScanner"),imageFilter=api.require("imageFilter"),isIOS="ios"==api.systemType,imageBrowser=api.require("imageBrowser"),null!=api.pageParam.index?getindexinfo():null!=api.pageParam.friid&&getidinfo(),api.parseTapmode()},Array.prototype.remove_arr=function(i){var e=this.indexOf(i);e>-1&&this.splice(e,1)}</script> </html>