<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <meta name=format-detection content="telephone=no,email=no,date=no,aItemress=no"> <title></title> <link rel=stylesheet type=text/css href=../../css/api.css /> <link rel=stylesheet type=text/css href=../../css/aui.css /> <link rel=stylesheet type=text/css href=../../css/aui-skin.css /> <link rel=stylesheet type=text/css href=../../css/tea.css /> <style type=text/css>.aui-list-item.wechat-top{background-color:#f3f3f7}.aui-list .wechat-avatar{width:3rem}.wechat-avatar .aui-row-padded{background-color:#dddee0;padding:.1rem;border-radius:.2rem;margin-left:-.05rem;margin-right:-.05rem}.wechat-avatar .aui-row-padded [class*=aui-col-xs-]{padding:.05rem}.wechat-avatar,.wechat-avatar>img{border-radius:.2rem}.icon-font{font-size:1.75rem!important}.li-padding{padding-top:.25rem!important;padding-bottom:.25rem!important}.aui-badge{height:.9rem;width:.9rem;line-height:.9rem;border-radius:50%}</style> </head> <body> <ul class="aui-list aui-media-list"> <li class="aui-list-item wechat-top aui-list-item-arrow tea-bg-white li-padding" tapmode onclick=openWinLocalFriends()> <div class=aui-media-list-item-inner> <div class=aui-list-item-label-icon style=min-width:2.5rem> <i class="aui-iconfont tea-icon-local icon-font" style=color:#f66></i> </div> <div class=aui-list-item-inner> 同城车友 <a class=aui-pull-right> <span class=aui-font-size-14 style=color:#f93>老司机带带我</span> </a> </div> </div> </li> <li class="aui-list-item wechat-top aui-list-item-arrow tea-bg-white li-padding" tapmode onclick=openWinNewFriends()> <div class=aui-media-list-item-inner> <div class=aui-list-item-label-icon style=min-width:2.5rem> <i class="aui-iconfont tea-icon-newfriend icon-font" style=color:#f96></i> </div> <div class=aui-list-item-inner> 新的朋友 <a class=aui-pull-right> <div id=newfriend class="aui-badge aui-font-size-16 aui-hide" style=position:relative;top:0;left:0>8</div> </a> </div> </div> </li> <li class="aui-list-item wechat-top aui-list-item-arrow tea-bg-white li-padding" tapmode onclick=openWinSuggestFriend()> <div class=aui-media-list-item-inner> <div class=aui-list-item-label-icon style=min-width:2.5rem> <i class="aui-iconfont tea-icon-recommend icon-font" style=color:#39f></i> </div> <div class=aui-list-item-inner> 好友推荐 <a class=aui-pull-right> <div id=suggest class="aui-badge tea-font-size-13 aui-hide" style=position:relative;top:0;left:0>9+</div> </a> </div> </div> </li> </ul> <div id=app class="aui-content aui-margin-b-15" v-cloak> <ul class="aui-list aui-media-list"> <li class="aui-list-item aui-list-item-middle" v-for="item in msgList" @click="openWinChat(item.chatType, item.chatId, item.chatName)" tapmode> <div class=aui-media-list-item-inner> <div class="aui-list-item-media wechat-avatar"> <div class="unread aui-badge" v-show=item.chatUnread> {{item.chatUnread}} </div> <img :src=item.chatAvatar /> </div> <div class=aui-list-item-inner> <div class=aui-list-item-text> <div class=aui-list-item-title>{{item.chatName}}</div> <div class="aui-list-item-right btime">{{tea.formatDate(item.chatTime, 'day')}}</div> </div> <div class="aui-list-item-title aui-font-size-12 msgnr tea-text-default aui-ellipsis-2" v-html="setLastMsgText(item.chatMsg, item.chatMsgType)"> </div> </div> </div> </li> </ul> </div> </body> <script src=../../script/api.js></script> <script src=../../script/aui-toast.js></script> <script src=../../script/conn.js></script> <script src=../../script/vue.min.js></script> <script src=../../script/rongyun.js></script> <script src=../../script/emo.js></script> <script src=../../script/tea.js></script> <script type=text/template id=template> </script> <script>function init(){dom={},updateHTML(),initModule(),initEventListener()}function initModule(e){function t(){"hideProgress"!=e&&api.showProgress({style:"default",animationType:"fade",title:"努力加载中...",text:"先喝杯茶...",modal:!1}),rongyun.getConversationList(function(e){vm.initList(e.result)})}vm.userId=$api.getStorage("ID"),api.showProgress({style:"default",animationType:"fade",title:"努力加载中...",text:"先喝杯茶...",modal:!1}),api.ajax({url:website+"rong/index2.php?action=getrongtoken",method:"post",timeout:30,dataType:"json",returnAll:!1,data:{values:{ID:$api.getStorage("ID"),nickname:$api.getStorage("nickname"),img:$api.getStorage("img")?$api.getStorage("img"):"123"}}},function(e,n){api.hideProgress(),e?($api.setStorage("rongtoken",e.token),rongyun.init(),rongyun.connect(t),rongyun.initEventListener()):tea.toast("ajax")}),getSuggest(e),getNewFriend(e)}function initList(){api.showProgress({style:"default",animationType:"fade",title:"努力加载中...",text:"先喝杯茶...",modal:!1}),rongyun.getConversationList(function(e){vm.initList(e.result)})}function initEventListener(){api.addEventListener({name:"loginSuccess"},function(e,t){initModule("hideProgress")}),api.addEventListener({name:"loginOut"},function(e,t){rongyun.loginOut()}),api.addEventListener({name:"sendMsgStart"},function(e,t){if(e&&e.value){rongyun.sendMsg(e.value,updateHTML);e.value}}),api.addEventListener({name:"getLastMsgStart"},function(e,t){if(e&&e.value){var n=e.value;rongyun.getLatestMessages(n.chatType,n.chatId)}}),api.addEventListener({name:"clearTheMessage"},function(e,t){e&&e.value}),api.addEventListener({name:"clearUnread"},function(e,t){if(e&&e.value){var n=e.value;rongyun.clearUnread(n.chatId,n.chatType,vm.clearUnread)}}),api.setRefreshHeaderInfo({visible:!0,loadingImg:"widget://image/refresh.png",bgColor:"#f4f4f4",textColor:"#fff",textDown:"下拉刷新...",textUp:"松开刷新...",showTime:!0},function(e,t){initList(),getSuggest(),getNewFriend()}),api.addEventListener({name:"getHistoryMessages"},function(e,t){rongyun.getHistoryMessages(e.value,function(e){api.sendEvent({name:"getHistoryMessagesDone",extra:e})})}),api.addEventListener({name:"delMsg"},function(e,t){rongyun.deleteMessages(e.value.msgId)}),api.addEventListener({name:"updataDot"},function(e,t){getNewFriend(),getSuggest()})}function updateHTML(){}function getChatData(e,t){var n=[],a=[];if((e=Array.isArray(e)?e:[e]).length<1)t(a);else{for(var i=0,s=e.length;i<s;i++){var r=e[i];r.msg=r.latestMessage?r.latestMessage:r.content,"RC:CmdMsg"==r.objectName&&(r.msg=$api.strToJson(r.content.data)),"RC:ImgTextMsg"==r.objectName&&(r.msg.text=r.msg.title);var o=$api.strToJson(r.msg.extra),g={chatId:r.senderUserId,targetId:r.targetId,chatTime:r.sentTime,chatAvatar:o.userphoto,chatName:o.username,chatMsg:r.msg.text,chatMsgType:r.objectName,chatUnread:r.unreadMessageCount,chatType:r.conversationType};r.senderUserId==vm.userId&&(g.chatId=r.targetId,g.chatTime=r.sentTime),n.push(g.chatId),a.push(g)}n.length<1?t(a):getUsersInfo(n.toString(),function(e){for(var n=0;n<e.length;n++)for(var i=e[n],s=0;s<a.length;s++){var r=a[s];r.chatId==i.userid&&(r.chatAvatar=website+i.userphoto,r.chatName=i.username)}t(a)})}}function getUsersInfo(e,t){tea.ajax({url:website+"rong/index.php?action=getlastuserlist&ids="+e,method:"get",timeout:30,dataType:"json",returnAll:!1},function(e,n){if(!e)return tea.toast("ajax"),!1;t(e)})}function openWinLocalFriends(){tea.openWin({name:"friends_local_win",url:"./friends_local_win.html",bounces:!1})}function openWinNewFriends(){tea.openWin({name:"new_friends_win",url:"./new_friends_win.html",bounces:!1,pageParam:{key:"value"}})}function openWinSuggestFriend(){api.openWin({name:"friend_suggest_win",url:"./friend_suggest_win.html",bounces:!1,pageParam:{key:"value"}})}function getSuggest(e){tea.showp("数据加载中","请稍候"),api.require("contacts").queryByPage({pageIndex:0},function(e,t){api.ajax({url:website+"friendship.php?action=fricommlist",method:"post",timeout:30,data:{values:{content:e,dm:api.deviceModel,ID:$api.getStorage("ID"),token:$api.getStorage("token")}}},function(e,t){if(api.hideProgress(),!e)return!1;if(e){var n,a=[];for(i in e)0==e[i].hadd&&a.push(e[i]);if(api.sendEvent({name:"messageUnread",extra:{type:"contacts",num:a.length}}),a.length>0)return n=a.length,a.length>9&&(n="9+"),$api.removeCls($api.byId("suggest"),"aui-hide"),void $api.text($api.byId("suggest"),n);$api.addCls($api.byId("suggest"),"aui-hide")}})})}function getNewFriend(e){tea.showp("数据加载中","请稍候"),api.ajax({url:website+"friendship.php?action=newcount",method:"post",timeout:30,data:{values:{ID:$api.getStorage("ID")}}},function(e,t){if(api.hideProgress(),!e)return!1;if(1==e.succ){if(api.sendEvent({name:"messageUnread",extra:{type:"friend",num:e.num}}),e.num>0)return $api.removeCls($api.byId("newfriend"),"aui-hide"),$api.text($api.byId("newfriend"),e.num),!0;$api.addCls($api.byId("newfriend"),"aui-hide")}})}var dom={},vm=null,rong=null;apiready=function(){vm=new Vue({el:"#app",data:{msgList:[],userId:$api.getStorage("ID")},methods:{initList:function(e){getChatData(e,function(e){vm.msgList=e,api.hideProgress(),api.refreshHeaderLoadDone()})},openWinChat:function(e,t,n){tea.openWin({name:"chat_win",url:"./chat_win.html",bounces:!1,pageParam:{chatType:e,chatId:t,chatName:n}})},setLastMsgText:function(e,t){var n="";switch(t){case"RC:TxtMsg":n=_transEmo(e);break;case"RC:VcMsg":n="[语音消息]";break;case"RC:ImgMsg":n="[图片消息]";break;case"RC:ImgTextMsg":n="<span class='tea-text-red'>[客户咨询]：</span>"+e;break;case"RC:news":n=""+msgObj.latestMessage.title;break;case"RC:CmdMsg":n="<span class='tea-text-blue'>[正在浏览]：</span>"+e}return n},updateHTML:function(e,t){function n(e){var n=vm.msgList;if(n.length>0)for(var a=0;a<n.length;a++){var i=n[a];if(i.chatId==e.chatId||i.chatId==e.targetId)return n.splice(a,1),void n.unshift(e)}n.unshift(e),"receive"==t&&api.notification({vibrate:[300,500],sound:"default",light:!0,notify:{title:"接收到新的消息",updateCurrent:!0}},function(e,t){api.cancelNotification({id:e.id})})}getChatData([e],function(e){var t=e[0];rong.getUnreadCount({conversationType:t.chatType,targetId:t.chatId},function(e,a){"success"===e.status&&(t.chatUnread=e.result,n(t))})})},clearUnread:function(e,t){var n=vm.msgList;if(n.length>0)for(var a=0;a<n.length;a++){var i=n[a];if(i.chatId==e)return void(i.chatUnread=0)}rong.getTotalUnreadCount(function(e,t){api.sendEvent({name:"messageUnread",extra:{type:"chat",num:e.result}})})}},watch:{}}),init()}</script> </html>