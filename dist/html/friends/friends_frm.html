<!DOCTYPE html> <html> <head> <meta charset=utf-8> <meta name=viewport content="maximum-scale=1,minimum-scale=1,user-scalable=0,width=device-width,initial-scale=1"/> <meta name=format-detection content="telephone=no,email=no,date=no,aItemress=no"> <title>车友</title> <link rel=stylesheet type=text/css href=../../css/api.css /> <link rel=stylesheet type=text/css href=../../css/aui.css /> <link rel=stylesheet type=text/css href=../../css/aui-skin.css /> <link rel=stylesheet type=text/css href=../../css/tea.css /> <style type=text/css>body,html{height:100%;overflow:auto}.aui-list-item.wechat-top{background-color:#f3f3f7}.aui-list .wechat-avatar{width:3rem}.wechat-avatar .aui-row-padded{background-color:#dddee0;padding:.1rem;border-radius:.2rem;margin-left:-.05rem;margin-right:-.05rem}.wechat-avatar .aui-row-padded [class*=aui-col-xs-]{padding:.05rem}.wechat-avatar,.wechat-avatar>img{border-radius:.2rem}</style> </head> <body> <div id=list class="aui-content aui-margin-b-15"> <ul class="aui-list aui-media-list"> <li class="aui-list-item wechat-top aui-list-item-arrow" tapmode onclick=openWinLocalFriends()> <div class=aui-media-list-item-inner> <div class=aui-list-item-label-icon> <i class="aui-iconfont aui-icon-mobile"></i> </div> <div class=aui-list-item-inner> 同城车友 </div> </div> </li> </ul> </div> </body> <script src=../../script/api.js></script> <script src=../../script/aui-toast.js></script> <script src=../../script/tea.js></script> <script src=../../script/conn.js></script> <script src=../../script/doT.min.js></script> <script src=../../script/linq.min.js></script> <script src=../../script/emo.js></script> <script src=../../script/zepto.min.js></script> <script type=text/template id=template> <li class="aui-list-item wechat-top aui-list-item-arrow" tapmode onclick="openWinLocalFriends();">
		<div class="aui-media-list-item-inner">
			<div class="aui-list-item-label-icon">
				<i class="aui-iconfont aui-icon-mobile"></i>
			</div>
			<div class="aui-list-item-inner">
				同城车友
			</div>
		</div>
	</li>
    {{~it:value:index}}
    <li class="aui-list-item aui-list-item-middle" data-conversationType="{{=value.conversationType}}" data-targetId="{{=value.chatId}}" data-targetName="{{=value.chatInfo.username}}"
        onclick="openWinChat(this)" tapmode>
        <div class="aui-media-list-item-inner">
            <div class="aui-list-item-media wechat-avatar">
                <div class="unread {{=(value.unreadMessageCount==0||value.unreadMessageCount==undefined? '' : 'aui-badge' )}}">
                    {{=(value.unreadMessageCount==0||value.unreadMessageCount==undefined? '' : value.unreadMessageCount )}}
                </div>
                <img src="{{=(website + value.chatInfo.userphoto)}}" />
            </div>
            <div class="aui-list-item-inner">
                <div class="aui-list-item-text">
                    <div class="aui-list-item-title">{{=value.chatInfo.username}}</div>
                    <div class="aui-list-item-right btime">{{=_formatDate(value.sentTime)}}</div>
                </div>
                <div class="aui-list-item-title aui-font-size-12 msgnr tea-text-default">
                    {{=setLastMsgText(value,true)}}
                </div>
            </div>
        </div>
    </li>
    {{~}} </script> <script>function init(){initModule(),initEventListener()}function initEventListener(){api.addEventListener({name:"loginSuccess"},function(e,s){initModule()}),api.setRefreshHeaderInfo({visible:!0,loadingImg:"widget://image/refresh.png",bgColor:"#f2f5f8",textColor:"#fff",textDown:"下拉刷新...",textUp:"松开刷新...",showTime:!0},function(e,s){rong_getConversationList()}),rong.setConnectionStatusListener(function(e,s){switch(e.result.connectionStatus){case"CONNECTED":"连接成功";break;case"CONNECTING":"连接中";break;case"DISCONNECTED":"断开连接";break;case"KICKED":"用户账户在其他设备登录，本机会被踢掉线";break;case"NETWORK_UNAVAILABLE":"网络不可用";break;case"SERVER_INVALID":"服务器异常或无法连接";break;case"TOKEN_INCORRECT":"Token 不正确";break;default:"未知错误"}}),rong_onMsgListener(),api.addEventListener({name:"sendMsgStart"},function(e,s){if(e&&e.value){var t=e.value;rong_sendMsg(t.msgType,t.conversationType,t.targetId,t.content,t.extra)}}),api.addEventListener({name:"getNewMsgStart"},function(e,s){if(e&&e.value){var t=e.value;rong_getLatestMessages(t.conversationType,t.targetId)}}),api.addEventListener({name:"clearTheMessages"},function(e,s){if(e&&e.value){var t=e.value;rong_clearMessages(t.conversationType,t.targetId),rong_getConversationList()}}),api.addEventListener({name:"clearMessages"},function(e,s){if(e&&e.value){var t=e.value;rong_clearMessagesUnreadStatus(t.conversationType,t.targetId),rong_getConversationList(),rong.getTotalUnreadCount(function(e,s){api.sendEvent({name:"messageUnread",extra:{num:e.result}})})}})}function initModule(){(rong=api.require("rongCloud2")).init(function(e,s){"error"==e.status&&tea.toast("fail","融云初始化未成功")});var e=$api.getStorage("rongtoken");e&&rong.connect({token:e},function(e,s){"success"==e.status?rong_getConversationList():tea.toast("fail","获取列表未成功")})}function getData(){}function updateHTML(){}function openWinChat(e){var s=$api.attr(e,"data-conversationType"),t=$api.attr(e,"data-targetId"),a=$api.attr(e,"data-targetName");rong_clearMessagesUnreadStatus(s,t),"PRIVATE"==s&&tea.openWin({name:"char_win",url:"./chat_win.html",bounces:!1,pageParam:{conversationType:s,targetId:t,targetName:a}})}function rong_getConversationList(){rong.getConversationList(function(e,s){e&&(e.result.length<1&&(isFirst=!1),showMsgList(e.result),rong.getTotalUnreadCount(function(e,s){api.sendEvent({name:"messageUnread",extra:{num:e.result}})}))})}function showMsgList(e){if(e&&e.length>0){for(var s=0;s<e.length;s++){var t=e[s];"PRIVATE"==t.conversationType&&(t.latestMessage.extra=$api.strToJson(t.latestMessage.extra),$api.getStorage("ID")==t.senderUserId?(t.chatId=t.targetId,users.push(t.targetId)):(t.chatId=t.senderUserId,t.sentTime=t.receivedTime,users.push(t.senderUserId)))}getUsersInfo(users.toString(),e)}else api.refreshHeaderLoadDone()}function rong_clearMessagesUnreadStatus(e,s){rong.clearMessagesUnreadStatus({conversationType:e,targetId:s},function(e,s){})}function rong_sendMsg(e,s,t,a,n){switch(e){case"text":rong.sendTextMessage({conversationType:s,targetId:t,text:a,extra:n},function(e,s){"prepare"==e.status?(_setStorage(e.result.message.messageId.toString(),e),_sendEvent("sendMsgPrepare",e.result.message)):"success"==e.status?(_sendEvent("sendMsgSuccess",e.result.message),sendMsgSuccessEnd(_getStorage(e.result.message.messageId.toString()))):"error"==e.status&&_sendEvent("sendMsgError",{errcode:s.code,messageId:e.result.message.messageId})});break;case"voice":rong.sendVoiceMessage({conversationType:s,targetId:t,voicePath:a,duration:$api.strToJson(n).duration,extra:n},function(e,s){if("prepare"==e.status)_setStorage(e.result.message.messageId.toString(),e),_sendEvent("sendMsgPrepare",e.result.message);else if("success"==e.status)_sendEvent("sendMsgSuccess",e.result.message),sendMsgSuccessEnd(_getStorage(e.result.message.messageId.toString()));else if("error"==e.status){if(void 0===e.result)return;var t=e.result.message.messageId;_sendEvent("sendMsgError",{errcode:s.code,messageId:t})}});break;case"image":rong.sendImageMessage({conversationType:s,targetId:t,imagePath:a,extra:n},function(e,s){"prepare"==e.status?(_setStorage(e.result.message.messageId.toString(),e),_sendEvent("sendMsgPrepare",e.result.message)):"progress"==e.status?_sendEvent("sendMsgProgress",e.result.progress):"success"==e.status?(_sendEvent("sendMsgSuccess",e.result.message),sendMsgSuccessEnd(_getStorage(e.result.message.messageId.toString()))):"error"==e.status&&_sendEvent("sendMsgError",{errcode:s.code,messageId:e.result.message.messageId})});break;case"richmsg":rong.sendRichContentMessage({conversationType:s,targetId:t,title:$api.strToJson(n).title,description:$api.strToJson(n).description,imageUrl:a,extra:n},function(e,s){"prepare"==e.status?(_setStorage(e.result.message.messageId.toString(),e),_sendEvent("sendMsgPrepare",e.result.message)):"success"==e.status?(_sendEvent("sendMsgSuccess",e.result.message),sendMsgSuccessEnd(_getStorage(e.result.message.messageId.toString()))):"error"==e.status&&_sendEvent("sendMsgError",{errcode:s.code,messageId:e.result.message.messageId})});break;case"location":rong.sendLocationMessage({conversationType:s,targetId:t,latitude:$api.strToJson(n).lat,longitude:$api.strToJson(n).lon,poi:$api.strToJson(n).poi,imagePath:a,extra:n},function(e,s){"prepare"==e.status?(_setStorage(e.result.message.messageId.toString(),e),_sendEvent("sendMsgPrepare",e.result.message)):"progress"==e.status?_sendEvent("sendMsgProgress",e.result.progress):"success"==e.status?(_sendEvent("sendMsgSuccess",e.result.message),sendMsgSuccessEnd(_getStorage(e.result.message.messageId.toString()))):"error"==e.status&&_sendEvent("sendMsgError",{errcode:s.code,messageId:e.result.message.messageId})});break;case"cmd":rong.sendCommandNotificationMessage({conversationType:s,targetId:t,name:$api.strToJson(n).name,data:n},function(e,s){"prepare"==e.status?(_setStorage(e.result.message.messageId.toString(),e),_sendEvent("sendMsgPrepare",e.result.message)):"success"==e.status?(_sendEvent("sendMsgSuccess",e.result.message),sendMsgSuccessEnd(_getStorage(e.result.message.messageId.toString()))):"error"==e.status&&_sendEvent("sendMsgError",{errcode:s.code,messageId:e.result.message.messageId})});break;case"wareCommand":rong.sendCommandMessage({conversationType:s,targetId:t,name:"AddFriend",data:a},function(e,s){})}}function rong_onMsgListener(){rong.setOnReceiveMessageListener(function(e,s){if(_sendEvent("receivedMsg",e.result.message),rong.getTotalUnreadCount(function(e,s){api.sendEvent({name:"messageUnread",extra:{num:e.result}})}),!isFirst){var t=e.result.message.senderUserId;if($("#list ul li[data-targetId='"+t+"']").size()>0){var a=$("#list ul li[data-targetId='"+t+"']");a.find(".msgnr").html(setLastMsgText(e.result.message,!1)),a.find(".btime").text(_formatDate(e.result.message.receivedTime)),rong.getUnreadCount({conversationType:e.result.message.conversationType,targetId:t},function(e,s){if("success"===e.status){_isNumber(e.result)&&0!==e.result&&(a.find(".unread").text(e.result),a.find(".unread").hasClass("aui-badge")||a.find(".unread").addClass("aui-badge"));var t=a.clone();a.remove(),$("#list ul").prepend(t)}})}else{var n=e.result.message;rong.getUnreadCount({conversationType:e.result.message.conversationType,targetId:t},function(e,s){"success"===e.status&&_isNumber(e.result)&&0!==e.result&&(n.unreadMessageCount=e.result,getUserByID(t,n))})}}isFirst||api.notification({vibrate:[300,500],sound:"default",light:!0,notify:{title:"接收到新的消息",content:void 0!=e.result.message.content.text?e.result.message.content.text:"",updateCurrent:!0,extra:JSON.stringify(e.result.message)}},function(e,s){})})}function rong_getLatestMessages(e,s){rong.getLatestMessages({conversationType:e,targetId:s,count:20},function(e,s){_sendEvent("getNewMsgEnd",e.result)})}function getUsersInfo(e,s){tea.ajax({url:website+"rong/index2.php?action=getlastuserlist&ids="+e,method:"get",timeout:30,dataType:"json",returnAll:!1},function(e,t){if(e){for(var a=0;a<s.length;a++){var n=s[a],r=Enumerable.From(e).Where("$.userid=="+n.chatId).ToArray();n.chatInfo=r[0]}var o=doT.template($("#template").text());$("#list ul").html(o(s)),api.parseTapmode(),isFirst=!1,api.hideProgress(),api.refreshHeaderLoadDone()}else tea.toast("ajax")})}function setLastMsgText(e,s){var t="";switch(e.objectName){case"RC:TxtMsg":t=s?_transEmo(e.latestMessage.text):_transEmo(e.content.text);break;case"RC:VcMsg":t="[语音消息]";break;case"RC:ImgMsg":t="[图片消息]";break;case"RC:ImgTextMsg":t=void 0===e.content?"[图文消息]："+e.latestMessage.extra.title:"[图文消息]："+e.content.title;break;case"RC:news":t=""+e.latestMessage.title;break;case"RC:CmdMsg":t=""+e.content.data}return t}function getUserByID(e,s){api.ajax({url:website+"rong/index2.php?action=getidtoinfo&userid="+e,method:"get",timeout:30,dataType:"json",returnAll:!1},function(e,t){if(e){s.chatId=s.senderUserId,s.chatInfo=e,s.latestMessage=s.content,s.sentTime=s.receivedTime;var a=[];a.push(s);var n=doT.template($("#template").text());$("#list ul").prepend(n(a))}else tea.toast("ajax")})}function sendMsgSuccessEnd(e){var s=e.result.message.targetId;if($("#list ul li[data-targetId='"+s+"']").size()>0){var t=$("#list ul li[data-targetId='"+s+"']");t.find(".msgnr").html(setLastMsgText(e.result.message,!1));var a=t.clone();t.remove(),$("#list ul").prepend(a)}else getUserByID(s,e.result.message);_removeStorage(e.result.message.messageId.toString())}function openWinLocalFriends(){api.openWin({name:"friends_local_win",url:"./friends_local_win.html",bounces:!1,pageParam:{key:"value"}})}apiready=function(){init(),getData()};var dom={},data={},values={},rong=null,users=[],isFirst=!0</script> </html>